# 自動粘貼功能使用指南

## 📋 功能說明

macOS 語音轉文字應用現在支持**自動粘貼到焦點應用**功能！

當語音轉文字完成後，應用會：
1. ✅ 自動複製文字到剪貼板
2. ✅ 檢測當前焦點應用（前台應用）
3. ✅ 自動模擬 `⌘V` 粘貼到該應用

---

## 🚀 快速開始

### 1. 安裝依賴

```bash
cd macos_menubar_app
pip install -r requirements.txt
```

新增的依賴：
- `pyobjc-framework-ApplicationServices` - 用於訪問 Accessibility API
- `pyobjc-framework-Quartz` - 用於模擬鍵盤事件

### 2. 授予輔助功能權限

**重要：自動粘貼功能需要輔助功能權限！**

#### 首次運行時：

1. 啟動應用：`python3 speech_to_clipboard.py`
2. 系統會自動彈出權限請求對話框
3. 點擊「打開系統偏好設置」
4. 在「安全性與隱私」→「輔助功能」中
5. 勾選 `Python` 或 `Terminal`（取決於你如何運行應用）

#### 手動授權：

1. 打開「系統偏好設置」
2. 前往「安全性與隱私」→「隱私」→「輔助功能」
3. 點擊左下角的鎖圖標解鎖
4. 添加 `Python` 或你的終端應用
5. 確保勾選框已選中

### 3. 使用自動粘貼

1. **啟動應用**
   ```bash
   python3 speech_to_clipboard.py
   ```

2. **確保自動粘貼已開啟**
   - 點擊狀態列的 🎤 圖標
   - 選擇「設定」→ 確認「✓ 自動粘貼到焦點應用」有勾選

3. **開始使用**
   - 打開任意應用（如 Slack、Notes、Terminal 等）
   - 點擊輸入框，確保光標在輸入位置
   - 按 `⌘R` 或點擊「開始錄音」
   - 說話
   - 按 `⌘R` 停止錄音
   - **文字會自動粘貼到光標位置！**

---

## 🎯 使用場景

### 場景 1：在 Slack 中快速發送消息

1. 打開 Slack，選擇頻道
2. 點擊輸入框
3. 按 `⌘R` 開始錄音
4. 說：「今天的會議改到下午 3 點」
5. 按 `⌘R` 停止
6. ✅ 文字自動出現在輸入框中
7. 按 Enter 發送

### 場景 2：在 Notes 中快速記錄想法

1. 打開 Notes 應用
2. 創建新筆記或打開現有筆記
3. 點擊編輯區域
4. 按 `⌘R`，說出你的想法
5. ✅ 想法自動記錄

### 場景 3：在 Terminal 中輸入命令

1. 打開 Terminal
2. 按 `⌘R`
3. 說：「git commit -m 添加自動粘貼功能」
4. ✅ 命令自動輸入到終端

### 場景 4：在瀏覽器輸入框中輸入

1. 打開瀏覽器（Chrome、Safari 等）
2. 點擊任意輸入框（如搜索框、評論框）
3. 使用語音輸入
4. ✅ 文字自動填入

---

## ⚙️ 設定選項

### 開啟/關閉自動粘貼

1. 點擊狀態列圖標
2. 選擇「設定」
3. 點擊「自動粘貼到焦點應用」切換

- **✓ 自動粘貼到焦點應用** - 已開啟（推薦）
- **自動粘貼到焦點應用** - 已關閉（只複製到剪貼板）

### 查看目標應用

自動粘貼時，系統通知會顯示：
```
語音轉文字完成
已自動粘貼到 Slack
```

---

## 🔧 工作原理

### 技術流程

```
1. 用戶停止錄音
   ↓
2. 音頻發送到 OpenAI Whisper API
   ↓
3. 獲得轉錄文字
   ↓
4. 複製到系統剪貼板
   ↓
5. 使用 NSWorkspace 檢測前台應用
   ↓
6. 使用 Quartz/CGEvent 模擬 ⌘V
   ↓
7. 文字自動粘貼到焦點應用
```

### 核心 API

- **NSWorkspace** - 獲取前台應用信息
- **ApplicationServices** - Accessibility 權限檢查
- **Quartz/CGEvent** - 模擬鍵盤事件
- **pyperclip** - 剪貼板操作

---

## ❓ 常見問題

### Q1: 自動粘貼沒有工作？

**A:** 檢查以下事項：
1. ✅ 確認已授予輔助功能權限
2. ✅ 確認自動粘貼功能已開啟（設定中有 ✓）
3. ✅ 確認目標應用的輸入框已獲得焦點（光標閃爍）
4. ✅ 查看終端日誌，檢查是否有錯誤信息

### Q2: 系統提示沒有權限？

**A:** 需要授予輔助功能權限：
1. 打開「系統偏好設置」→「安全性與隱私」→「輔助功能」
2. 解鎖（點擊左下角鎖圖標）
3. 添加並勾選 `Python` 或 `Terminal`
4. 重啟應用

### Q3: 粘貼到錯誤的位置？

**A:** 確保：
- 目標應用是當前前台應用
- 光標在正確的輸入框中
- 在停止錄音後，不要立即切換應用

### Q4: 可以在所有應用中使用嗎？

**A:** 是的！支持所有 macOS 應用，包括：
- ✅ Slack, Discord, Teams
- ✅ Notes, Notion, Obsidian
- ✅ Terminal, iTerm2
- ✅ Chrome, Safari, Firefox
- ✅ Mail, Messages
- ✅ VS Code, Xcode
- ✅ 任何文本編輯器

### Q5: 自動粘貼的延遲是多少？

**A:** 通常 <100ms：
- 複製到剪貼板：~10ms
- 檢測焦點應用：~10ms
- 模擬按鍵：~40ms
- 總延遲：~60-100ms（幾乎無感）

### Q6: 會覆蓋原有的剪貼板內容嗎？

**A:** 是的，語音轉文字的結果會替換剪貼板內容。如果需要保留原有內容，可以：
- 關閉自動粘貼功能
- 或在錄音前複製重要內容到其他地方

### Q7: 日誌中看到「已模擬 Command+V」但沒有粘貼？

**A:** 可能原因：
1. 目標應用不接受粘貼操作（如某些受保護的輸入框）
2. 焦點不在可編輯區域
3. 權限問題（重新授予輔助功能權限）

---

## 🎯 最佳實踐

### 1. 確保光標位置

在開始錄音前：
- ✅ 點擊目標輸入框
- ✅ 確認光標在正確位置
- ✅ 不要在錄音過程中切換應用

### 2. 使用快捷鍵提高效率

- `⌘R` - 開始/停止錄音
- 無需點擊菜單，全程鍵盤操作

### 3. 短句更準確

- ✅ 推薦：每次錄音 5-30 秒
- ⚠️ 避免：超長錄音（>1 分鐘）

### 4. 檢查通知確認

每次自動粘貼後，查看通知確認：
- 粘貼到了哪個應用
- 是否成功

---

## 🔍 調試模式

### 查看詳細日誌

運行應用時會顯示詳細日誌：

```bash
python3 speech_to_clipboard.py
```

日誌示例：
```
INFO:__main__:開始錄音...
INFO:__main__:停止錄音，開始轉換...
INFO:__main__:音頻已保存到: /tmp/tmpXXXXX.wav
INFO:__main__:轉換結果: 今天的會議改到下午三點
INFO:__main__:已複製到剪貼板
INFO:__main__:目標應用: Slack
INFO:__main__:已模擬 Command+V
INFO:__main__:已自動粘貼到 Slack
```

### 日誌級別

如需更詳細的調試信息，修改代碼中的日誌級別：

```python
logging.basicConfig(level=logging.DEBUG)  # 改為 DEBUG
```

---

## 🚀 進階功能（未來）

計劃中的功能：

- [ ] 特定應用的粘貼行為定制
  - Slack: 粘貼後可選自動發送
  - Terminal: 自動轉義特殊字符
  - 代碼編輯器: 保持代碼格式

- [ ] 粘貼歷史管理
  - 撤銷粘貼（Command+Z）
  - 查看粘貼歷史

- [ ] 智能粘貼位置
  - 檢測輸入框是否為空
  - 選擇追加或替換模式

---

## 📚 相關文檔

- [macOS 應用完整文檔](README.md)
- [Focused App 檢測技術](../docs/MACOS_FOCUSED_APP_DETECTION.md)
- [iPhone 遠程粘貼評估](../IPHONE_MACOS_AUTO_PASTE_EVALUATION.md)

---

## ✅ 快速檢查清單

在使用自動粘貼功能前，確認：

- [ ] 已安裝所有依賴（`pip install -r requirements.txt`）
- [ ] 已授予輔助功能權限
- [ ] 已設置 `OPENAI_API_KEY` 環境變量
- [ ] 自動粘貼功能已開啟（設定菜單中有 ✓）
- [ ] 目標應用已打開並且輸入框已獲得焦點

一切就緒！開始使用語音轉文字 + 自動粘貼功能吧！🎉

---

**版本**: v1.1.0
**更新日期**: 2025-11-08
**項目**: 2025 AI FUNkathon - Speech to Action
